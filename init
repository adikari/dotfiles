#!/bin/bash

set -euo pipefail

# create backup directory
backup_dir="/tmp/dotfiles_$(date +%Y%m%d)"
bin=/usr/local/bin
dotfiles=$HOME/dotfiles
restart_required=false

kitty_dir=$HOME/.config/kitty
karabiner_dir=$HOME/.config/karabiner
nvim_dir=$HOME/.config/nvim
powerlevel10k_dir=$HOME/powerlevel10k

# create backup
backup() {
  if [ ! -d $backup_dir ]; then
    mkdir "$backup_dir"
    echo "Backup directory $backup_dir created."
  fi

  if [ -f $1 ]; then
    echo $1
    mv $1 $backup_dir
    echo "$1 is backed up in $backup_dir"
  fi
}

# check if given command is available
has_command() {
  command -v $1 >/dev/null 2>&1
}

# create symlink
link() {
  if ! diff $1 $2 &>/dev/null; then
    backup $2; ln -sf $1 $2 2>/dev/null

    echo "$2 is successfully linked."

    if [ "$2" == "zshrc" ]; then restart_required=true; fi
  fi
}

if [[ "$OSTYPE" == "darwin"* ]]; then
  echo "Platform is mac osx. Installing.."
  ./bin/osx-bootstrap

  link $dotfiles/configs/yabairc $HOME/.yabairc
  link $dotfiles/configs/hammerspoon/init.lua $HOME/.hammerspoon/init.lua
  link $dotfiles/configs/hammerspoon/yabai.lua $HOME/.hammerspoon/yabai.lua

    [ ! -d $karabiner_dir ] && mkdir $karabiner_dir
  link $dotfiles/configs/karabiner/karabiner.json $karabiner_dir/karabiner.json
fi

link $dotfiles/configs/gitconfig $HOME/.gitconfig

link $dotfiles/zsh/zshrc $HOME/.zshrc
link $dotfiles/tmux/tmux.conf $HOME/.tmux.conf

[ ! -d $kitty_dir ] && mkdir $kitty_dir
link $dotfiles/configs/kitty/kitty.conf $kitty_dir/kitty.conf

echo "installing tmux-plugins"
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
  git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm
fi

if has_command nvim; then
  echo "nvim found. configuring to use nvim.."

  if [ ! -d $nvim_dir ]; then 
    mkdir -p $nvim_dir
    git clone https://github.com/NvChad/NvChad $nvim_dir --depth 1 
  else 
    echo "$nvim_dir is not empty. skipping.."
  fi

  link $dotfiles/nvim $HOME/.config/nvim/lua/custom
fi

if [ ! -d $powerlevel10k_dir ]; then
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git $powerlevel10k_dir
fi

echo "Hurray!!! Dotfiles successfully setup."

if [ "$restart_required" = true ]; then
   echo "You must restart your session in order for configurations to take affect!!!"
else 
  echo "Restarting shell"
  exec zsh
fi

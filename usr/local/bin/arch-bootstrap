#!/bin/bash

set -euo pipefail

current_dir=$(pwd)
ARCH=$(uname -m)

remove_package() {
  if yay -Qs $1 &>> /dev/null; then
    yay -R --noconfirm $1
  fi
}

install_package() {
  if yay -Q $1 &>> /dev/null; then
   echo "$1 is already installed"
  else
    yay -S $1 --noconfirm 
  fi
}

if [ ! -f /sbin/yay ]; then
  echo "installing yay"
  cd /tmp
  sudo pacman -S --needed git base-devel --noconfirm
  [ ! -d /tmp/yay ] && git clone https://aur.archlinux.org/yay.git 
  cd yay && makepkg -si --noconfirm
  cd $current_dir
fi

yay -Suy --noconfirm

packages=(
  cmake
  openssl  
  zsh   
  bash
  openvpn
  curl
  unzip
  tar
  fzf
  ripgrep
  jq
  make
  stow

  # development
  go
  rustup
  aws-cli
  github-cli
  lua
  tmux
  neovim
  yarn
  pnpm
  npm
  python-requests 
  pacman-contrib

  # desktop environment with hyprland
  hyprland-git
  waybar
  xdg-desktop-portal-hyprland 
  gtk3 
  polkit-gnome
  gnome-keyring
  pipewire 
  pipewire-pulse
  wireplumber 
  mako 
  swww 
  swayidle
  swaylock-effects  
  rofi-lbonn-wayland-git
  wlogout  
  pamixer 
  pavucontrol 
  brightnessctl 
  bluez 
  bluez-utils 
  blueman 
  network-manager-applet 
  gvfs 
  file-roller
  papirus-icon-theme 
  xfce4-settings
  nwg-look-bin   
  sddm
  qt5ct
  qt5-wayland 
  qt6-wayland 
  qt6ct
  qt5-svg
  qt5-quickcontrols2
  qt5-graphicaleffects
  catppuccin-gtk-theme-mocha 
  
  cliphist 
  wl-clipboard 
  swappy 
  grim 
  slurp 
  btop
  hyprpicker-git

  # mutt
  neomutt
  notmuch
 
   # applications
  mpv
  aws-vault
  kitty
  docker
  thunderbird
  brave-bin  
  postman-bin
  thunar 
  thunar-archive-plugin 

  # discord
  # slack

  # fonts
  ttf-fantasque-nerd
  ttf-jetbrains-mono-nerd 
  ttf-nato-sans-nerd 
  noto-fonts-emoji 
  noto-fonts
)

echo "installing packages"
for package in ${packages[@]}; do
  install_package $package
done

if [ ! -f /usr/bin/op ]; then
  echo "installing 1password cli"
  gpg --receive-keys 3FEF9748469ADBE15DA7CA80AC2D62742012EA22
  yay -S 1password-cli --noconfirm
fi

if [ ! -f /opt/1Password/1password ]; then
  echo "installing 1password.."
  cd /tmp
  if [ ! -f /tmp/1password-latest.tar.gz ]; then
    curl -SO https://downloads.1password.com/linux/tar/stable/$ARCH/1password-latest.tar.gz
    sudo tar -xf 1password-latest.tar.gz
  fi
  sudo mkdir -p /opt/1Password
  sudo mv 1password-*/* /opt/1Password
  sudo /opt/1Password/after-install.sh
  cd $current_dir
fi

# install graphics drivers for m1 macbook pro
if [[ $ARCH = "arm64" || $ARCH = "aarch64" ]]; then
  yay -S --noconfirm linux-asahi-edge mesa-asahi-edge
  sudo update-grub
fi

echo "installing default rust.."
rustup default stable

echo "installing fnm.."
cargo install fnm

echo -e "Cleaning out conflicting xdg portals..."

remove_package xdg-desktop-portal-gnome 
remove_package xdg-desktop-portal-gtk 

echo "Starting the Bluetooth Service..."
sudo systemctl enable --now bluetooth.service 
sleep 2

echo "Enabling the SDDM Service..."
sudo systemctl enable sddm 
sleep 2

echo "Setting timezone"
sudo timedatectl set-timezone Australia/Melbourne

# Copy the SDDM theme
if [ ! -d /usr/share/sddm/themes/sdt ]; then
  echo "Setting up the login screen."
  sudo cp -R extras/sdt /usr/share/sddm/themes/
  sudo chown -R $USER:$USER /usr/share/sddm/themes/sdt
fi

$HOME/dotfiles/bin/set-theme

# exec sudo systemctl start sddm
echo "ðŸŽ‰  completed arch bootstrap"
